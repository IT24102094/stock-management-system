<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Bill</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/css/form-theme.css}" rel="stylesheet">
</head>
<body>
    <div class="bg-animation"></div>

    <div class="container-fluid">
        <div class="form-container" style="max-width: 1000px;">
            <div class="form-header">
                <div class="user-avatar">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <h2>Edit Bill</h2>
                <p>Update bill information and items</p>
            </div>

            <form th:action="@{/bills/edit/{id}(id=${bill.id})}" method="post" id="billForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                
                <!-- Bill Information -->
                <h5><i class="fas fa-info-circle me-2"></i>Bill Information</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Bill Number</label>
                        <input type="text" class="form-control" th:value="${bill.billNumber}" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Bill Date</label>
                        <input type="text" class="form-control" 
                               th:value="${bill.billDate != null ? #temporals.format(bill.billDate, 'MMM dd, yyyy HH:mm') : 'N/A'}" 
                               readonly>
                    </div>
                </div>

                <!-- Customer Information -->
                <h5><i class="fas fa-user-friends me-2"></i>Customer Information</h5>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="customerId" class="form-label">Customer <span class="text-danger">*</span></label>
                        <select class="form-select" id="customerId" name="customerId" required>
                            <option value="">Select Customer</option>
                            <option th:each="c : ${customers}" 
                                    th:value="${c.id}" 
                                    th:selected="${bill.customer != null and c.id == bill.customer.id}"
                                    th:text="${c.firstName + ' ' + c.lastName + ' (' + c.email + ')'}">Customer Name</option>
                        </select>
                    </div>
                </div>

                <!-- Product Items -->
                <h5 class="mt-4"><i class="fas fa-shopping-cart me-2"></i>Bill Items</h5>
                
                <div id="itemsContainer">
                    <!-- Existing items -->
                    <div class="item-row row mb-3" th:each="item, iterStat : ${bill.items}">
                        <div class="col-md-5">
                            <label class="form-label" th:if="${iterStat.first}">Product <span class="text-danger">*</span></label>
                            <select class="form-select product-select" name="productId" required>
                                <option value="">Select Product</option>
                                <option th:each="p : ${products}" 
                                        th:value="${p.id}" 
                                        th:selected="${item.product != null and p.id == item.product.id}"
                                        th:data-price="${p.price}"
                                        th:text="${p.name + ' - $' + p.price}">Product Name</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" th:if="${iterStat.first}">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control quantity-input" name="quantity" 
                                   th:value="${item.quantity}" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" th:if="${iterStat.first}">Unit Price <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" class="form-control price-input" name="unitPrice" 
                                   th:value="${item.unitPrice}" readonly required>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label" th:if="${iterStat.first}">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm remove-item" 
                                    th:style="${#lists.size(bill.items) == 1 ? 'display:none;' : 'display:inline-block;'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- If no items, show one empty row -->
                    <div class="item-row row mb-3" th:if="${#lists.isEmpty(bill.items)}">
                        <div class="col-md-5">
                            <label class="form-label">Product <span class="text-danger">*</span></label>
                            <select class="form-select product-select" name="productId" required>
                                <option value="">Select Product</option>
                                <option th:each="p : ${products}" th:value="${p.id}" 
                                        th:data-price="${p.price}"
                                        th:text="${p.name + ' - $' + p.price}">Product Name</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control quantity-input" name="quantity" min="1" value="1" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Unit Price <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" class="form-control price-input" name="unitPrice" readonly required>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm remove-item" style="display:none;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="addItem">
                    <i class="fas fa-plus"></i> Add Another Item
                </button>

                <!-- Payment Information -->
                <h5 class="mt-4"><i class="fas fa-credit-card me-2"></i>Payment Information</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" name="paymentMethod">
                            <option value="">Select Payment Method</option>
                            <option value="CASH" th:selected="${bill.paymentMethod == 'CASH'}">Cash</option>
                            <option value="CREDIT_CARD" th:selected="${bill.paymentMethod == 'CREDIT_CARD'}">Credit Card</option>
                            <option value="DEBIT_CARD" th:selected="${bill.paymentMethod == 'DEBIT_CARD'}">Debit Card</option>
                            <option value="BANK_TRANSFER" th:selected="${bill.paymentMethod == 'BANK_TRANSFER'}">Bank Transfer</option>
                            <option value="MOBILE_PAYMENT" th:selected="${bill.paymentMethod == 'MOBILE_PAYMENT'}">Mobile Payment</option>
                            <option value="CHECK" th:selected="${bill.paymentMethod == 'CHECK'}">Check</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="paymentReference" class="form-label">Payment Reference/Transaction ID</label>
                        <input type="text" class="form-control" id="paymentReference" name="paymentReference" 
                               th:value="${bill.paymentReference}"
                               placeholder="Optional - Transaction ID, Check #, etc.">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="amountPaid" class="form-label">Amount Paid</label>
                        <input type="number" step="0.01" class="form-control" id="amountPaid" name="amountPaid" 
                               th:value="${bill.amountPaid}"
                               placeholder="Enter amount paid" min="0">
                        <small class="form-text" style="color: rgba(255,255,255,0.7);">Enter amount if customer is paying now</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="billStatus" class="form-label">Bill Status</label>
                        <select class="form-select" id="billStatus" name="status">
                            <option value="PENDING" th:selected="${bill.status?.name() == 'PENDING'}">Pending</option>
                            <option value="PAID" th:selected="${bill.status?.name() == 'PAID'}">Paid</option>
                            <option value="PARTIAL" th:selected="${bill.status?.name() == 'PARTIAL'}">Partially Paid</option>
                            <option value="CANCELLED" th:selected="${bill.status?.name() == 'CANCELLED'}">Cancelled</option>
                        </select>
                    </div>
                </div>

                <!-- Notes -->
                <h5 class="mt-4"><i class="fas fa-sticky-note me-2"></i>Additional Notes</h5>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Special instructions, delivery notes, etc." th:text="${bill.notes}"></textarea>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions mt-4">
                    <a th:href="@{/bills/view/{id}(id=${bill.id})}" class="btn btn-secondary-modern">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-modern">
                        <i class="fas fa-save me-2"></i>Update Bill
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Add item functionality
        document.getElementById('addItem').addEventListener('click', function() {
            const container = document.getElementById('itemsContainer');
            const firstItem = container.querySelector('.item-row');
            const newItem = firstItem.cloneNode(true);
            
            // Clear values
            newItem.querySelector('.product-select').value = '';
            newItem.querySelector('.quantity-input').value = '1';
            newItem.querySelector('.price-input').value = '';
            
            // Remove label from cloned item
            const labels = newItem.querySelectorAll('label');
            labels.forEach(label => label.remove());
            
            newItem.querySelector('.remove-item').style.display = 'inline-block';
            
            container.appendChild(newItem);
            updateRemoveButtons();
        });
        
        // Remove item functionality
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-item')) {
                const itemRow = e.target.closest('.item-row');
                itemRow.remove();
                updateRemoveButtons();
            }
        });
        
        // Update remove buttons visibility
        function updateRemoveButtons() {
            const items = document.querySelectorAll('.item-row');
            items.forEach((item, index) => {
                const removeBtn = item.querySelector('.remove-item');
                if (items.length > 1) {
                    removeBtn.style.display = 'inline-block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        // Auto-populate price when product is selected
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('product-select')) {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const price = selectedOption.getAttribute('data-price');
                const priceInput = e.target.closest('.item-row').querySelector('.price-input');
                priceInput.value = price || '';
            }
        });
        
        // Form validation
        document.getElementById('billForm').addEventListener('submit', function(e) {
            const items = document.querySelectorAll('.item-row');
            let isValid = true;
            
            items.forEach(item => {
                const productSelect = item.querySelector('.product-select');
                const quantityInput = item.querySelector('.quantity-input');
                const priceInput = item.querySelector('.price-input');
                
                if (!productSelect.value || !quantityInput.value || !priceInput.value) {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Please fill all product, quantity, and price fields');
            }
        });
    </script>
</body>
</html>
