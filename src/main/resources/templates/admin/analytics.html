<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - Stock Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        .analytics-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 15px;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-icon {
            font-size: 2rem;
            color: #3498db;
            opacity: 0.8;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin: 1rem 0;
        }
        
        .chart-small {
            height: 250px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-up { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-critical { background-color: #e74c3c; }
        .status-normal { background-color: #3498db; }
        
        .user-activity-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3498db;
        }
        
        .security-alert {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .performance-good {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        }
        
        .performance-warning {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
        }
        
        .analytics-section {
            margin-bottom: 3rem;
        }
        
        .section-title {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .export-buttons {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .refresh-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="analytics-header text-center">
            <div class="container">
                <h1><i class="fas fa-chart-line"></i> Advanced Analytics Dashboard</h1>
                <p class="mb-0">Comprehensive system insights and performance metrics</p>
                <div class="mt-3">
                    <a href="/admin/dashboard" class="btn btn-light me-2">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    <a href="/admin/reports" class="btn btn-outline-light">
                        <i class="fas fa-chart-bar"></i> Basic Reports
                    </a>
                </div>
            </div>
        </div>

        <!-- User Statistics -->
        <div class="analytics-section">
            <h2 class="section-title"><i class="fas fa-users"></i> User Analytics</h2>
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-users metric-icon"></i>
                        <div class="metric-value" th:text="${userStats.totalUsers}">0</div>
                        <div class="metric-label">Total Users</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-user-check metric-icon text-success"></i>
                        <div class="metric-value" th:text="${userStats.activeUsers}">0</div>
                        <div class="metric-label">Active Users</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-user-times metric-icon text-warning"></i>
                        <div class="metric-value" th:text="${userStats.inactiveUsers}">0</div>
                        <div class="metric-label">Inactive Users</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-user-plus metric-icon text-info"></i>
                        <div class="metric-value" th:text="${userStats.newUsersLastMonth}">0</div>
                        <div class="metric-label">New Users (30d)</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <div class="metric-card">
                        <h5><i class="fas fa-chart-line text-primary"></i> User Registration Trend</h5>
                        <div class="chart-container">
                            <canvas id="registrationTrendChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="metric-card">
                        <h5><i class="fas fa-chart-pie text-primary"></i> User Distribution by Role</h5>
                        <div class="chart-container chart-small">
                            <canvas id="userDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Analytics -->
        <div class="analytics-section">
            <h2 class="section-title"><i class="fas fa-shield-alt"></i> Security Analytics</h2>
            <div class="row">
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-exclamation-triangle metric-icon text-danger"></i>
                        <div class="metric-value" th:text="${securityAnalytics.failedLoginsCount}">0</div>
                        <div class="metric-label">Failed Logins (7d)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-globe metric-icon text-info"></i>
                        <div class="metric-value" th:text="${securityAnalytics.uniqueIpAddresses}">0</div>
                        <div class="metric-label">Unique IP Addresses</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-clock metric-icon text-success"></i>
                        <div class="metric-value" th:text="${securityAnalytics.recentActivityCount}">0</div>
                        <div class="metric-label">Activity (24h)</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="metric-card text-center">
                        <i class="fas fa-chart-line metric-icon text-warning"></i>
                        <div class="metric-value" id="securityScore">85</div>
                        <div class="metric-label">Security Score</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-6">
                    <div class="metric-card">
                        <h5><i class="fas fa-clock text-primary"></i> Activity by Hour (24h)</h5>
                        <div class="chart-container chart-small">
                            <canvas id="hourlyActivityChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="metric-card">
                        <h5><i class="fas fa-calendar-week text-primary"></i> Activity by Day (7d)</h5>
                        <div class="chart-container chart-small">
                            <canvas id="dailyActivityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="analytics-section">
            <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Performance Metrics</h2>
            <div class="row">
                <div class="col-lg-4">
                    <div class="metric-card">
                        <h5><i class="fas fa-server text-primary"></i> System Health</h5>
                        <div th:each="metric : ${systemHealth}" class="d-flex align-items-center mb-2">
                            <span th:class="'status-indicator status-' + ${metric.status.toLowerCase()}"></span>
                            <div class="flex-grow-1">
                                <div class="fw-bold" th:text="${metric.name}">Metric Name</div>
                                <small class="text-muted" th:text="${metric.status}">Status</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="metric-card">
                        <h5><i class="fas fa-users-cog text-primary"></i> Top Active Users</h5>
                        <div th:each="user, iterStat : ${topActiveUsers}" th:if="${iterStat.index < 5}" 
                             class="user-activity-item">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold" th:text="${user.username}">Username</span>
                                <span class="badge bg-primary" th:text="${user.activityCount}">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="metric-card">
                        <h5><i class="fas fa-bolt text-primary"></i> Performance Stats</h5>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Hourly Activity:</span>
                                <strong th:text="${performanceMetrics.hourlyActivity}">0</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Daily Activity:</span>
                                <strong th:text="${performanceMetrics.dailyActivity}">0</strong>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Active Sessions:</span>
                                <strong th:text="${performanceMetrics.activeSessions}">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="analytics-section">
            <h2 class="section-title"><i class="fas fa-download"></i> Export Reports</h2>
            <div class="export-buttons">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-primary w-100" onclick="exportDetailedAuditReport()">
                            <i class="fas fa-file-pdf"></i> Detailed Audit Report
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-success w-100" onclick="exportSecurityReport()">
                            <i class="fas fa-shield-alt"></i> Security Report
                        </button>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button class="btn btn-info w-100" onclick="exportUserActivityReport()">
                            <i class="fas fa-users"></i> User Activity Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn btn-primary btn-lg rounded-circle refresh-button" onclick="refreshAnalytics()" title="Refresh Data">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart configurations
        const chartColors = {
            primary: '#3498db',
            success: '#27ae60',
            warning: '#f39c12',
            danger: '#e74c3c',
            info: '#17a2b8',
            light: '#ecf0f1',
            dark: '#2c3e50'
        };

        let charts = {};

        // Initialize all charts
        function initializeCharts() {
            // Registration Trend Chart
            const regTrendCtx = document.getElementById('registrationTrendChart').getContext('2d');
            charts.registrationTrend = new Chart(regTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'New Registrations',
                        data: [],
                        borderColor: chartColors.primary,
                        backgroundColor: chartColors.primary + '20',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // User Distribution Chart
            const userDistCtx = document.getElementById('userDistributionChart').getContext('2d');
            charts.userDistribution = new Chart(userDistCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            chartColors.primary,
                            chartColors.success,
                            chartColors.warning,
                            chartColors.danger,
                            chartColors.info
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Hourly Activity Chart
            const hourlyCtx = document.getElementById('hourlyActivityChart').getContext('2d');
            charts.hourlyActivity = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Activity Count',
                        data: [],
                        backgroundColor: chartColors.info + '80',
                        borderColor: chartColors.info,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Daily Activity Chart
            const dailyCtx = document.getElementById('dailyActivityChart').getContext('2d');
            charts.dailyActivity = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Daily Activity',
                        data: [],
                        borderColor: chartColors.success,
                        backgroundColor: chartColors.success + '20',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Load chart data
        async function loadChartData() {
            try {
                // Load user statistics
                const userStatsResponse = await fetch('/admin/reports/api/user-statistics');
                const userStats = await userStatsResponse.json();
                
                if (userStats.registrationTrend) {
                    charts.registrationTrend.data.labels = userStats.registrationTrend.map(item => item.date);
                    charts.registrationTrend.data.datasets[0].data = userStats.registrationTrend.map(item => item.count);
                    charts.registrationTrend.update();
                }

                // Load user distribution
                const userDistResponse = await fetch('/admin/reports/api/user-distribution');
                const userDist = await userDistResponse.json();
                
                charts.userDistribution.data.labels = Object.keys(userDist);
                charts.userDistribution.data.datasets[0].data = Object.values(userDist);
                charts.userDistribution.update();

                // Load hourly activity
                const hourlyResponse = await fetch('/admin/reports/api/activity-by-hour');
                const hourlyData = await hourlyResponse.json();
                
                charts.hourlyActivity.data.labels = Object.keys(hourlyData);
                charts.hourlyActivity.data.datasets[0].data = Object.values(hourlyData);
                charts.hourlyActivity.update();

                // Load daily activity
                const dailyResponse = await fetch('/admin/reports/api/activity-by-day');
                const dailyData = await dailyResponse.json();
                
                charts.dailyActivity.data.labels = Object.keys(dailyData);
                charts.dailyActivity.data.datasets[0].data = Object.values(dailyData);
                charts.dailyActivity.update();

            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Export functions
        function exportDetailedAuditReport() {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            const endDate = new Date();
            
            const params = new URLSearchParams({
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString()
            });
            
            window.open(`/admin/reports/export/detailed-audit-report?${params}`, '_blank');
        }

        function exportSecurityReport() {
            window.open('/admin/reports/export/security-report?days=30', '_blank');
        }

        function exportUserActivityReport() {
            // This would typically open a modal to select user and date range
            alert('User Activity Report: Please select a specific user from the User Management section first.');
        }

        // Refresh analytics data
        function refreshAnalytics() {
            const refreshBtn = document.querySelector('.refresh-button i');
            refreshBtn.classList.add('fa-spin');
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadChartData();
        });
    </script>
</body>
</html>