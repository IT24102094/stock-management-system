<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create User - Stock Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
        }

        .form-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .form-control, .form-select {
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .is-invalid {
            border-color: var(--danger-color);
        }

        .invalid-feedback {
            display: block;
        }

        .password-strength {
            height: 5px;
            border-radius: 3px;
            margin-top: 5px;
            background-color: #e9ecef;
        }

        .password-strength-bar {
            height: 100%;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .strength-weak { background-color: #e74c3c; width: 25%; }
        .strength-fair { background-color: #f39c12; width: 50%; }
        .strength-good { background-color: #f1c40f; width: 75%; }
        .strength-strong { background-color: #27ae60; width: 100%; }

        .availability-check {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .available { color: var(--success-color); }
        .unavailable { color: var(--danger-color); }
        .checking { color: var(--secondary-color); }
    </style>
</head>
<body style="background-color: #f8f9fa;">
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="form-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1"><i class="fas fa-user-plus text-primary"></i> Create New User</h2>
                        <p class="text-muted mb-0">Add a new user to the system</p>
                    </div>
                    <a href="/users" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Users
                    </a>
                </div>

                <form th:action="@{/users/create}" method="post" th:object="${userCreateDTO}" id="createUserForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="text" class="form-control" th:field="*{username}" id="username"
                                       placeholder="Enter username" required>
                                <div class="availability-check" id="usernameCheck"></div>
                            </div>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('username')}"
                                 th:errors="*{username}"></div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="email" class="form-control" th:field="*{email}" id="email"
                                       placeholder="Enter email address" required>
                                <div class="availability-check" id="emailCheck"></div>
                            </div>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}"
                                 th:errors="*{email}"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" th:field="*{firstName}" id="firstName"
                                   placeholder="Enter first name" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('firstName')}"
                                 th:errors="*{firstName}"></div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" th:field="*{lastName}" id="lastName"
                                   placeholder="Enter last name" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('lastName')}"
                                 th:errors="*{lastName}"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" th:field="*{password}" id="password"
                                   placeholder="Enter password" required minlength="8"
                                   pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}">
                            <div class="password-strength">
                                <div class="password-strength-bar" id="strengthBar"></div>
                            </div>
                            <small class="text-muted" id="strengthText">Password strength: None</small>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}"
                                 th:errors="*{password}"></div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="confirmPassword" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" th:field="*{confirmPassword}" id="confirmPassword"
                                   placeholder="Confirm password" required minlength="8">
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmPassword')}"
                                 th:errors="*{confirmPassword}"></div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" th:field="*{role}" id="role" required>
                                <option value="">Select a role</option>
                                <option th:each="role : ${roles}" th:value="${role.name()}" th:text="${role.name().replace('_', ' ')}">ADMIN</option>
                            </select>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('role')}"
                                 th:errors="*{role}"></div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/users" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="submitSpinner"></span>
                            <i class="fas fa-save" id="submitIcon"></i> Create User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('createUserForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitSpinner = document.getElementById('submitSpinner');
        const submitIcon = document.getElementById('submitIcon');

        // Username availability check
        const usernameInput = document.getElementById('username');
        const usernameCheck = document.getElementById('usernameCheck');
        let usernameTimeout;

        usernameInput.addEventListener('input', function() {
            clearTimeout(usernameTimeout);
            const username = this.value.trim();

            if (username.length < 3) {
                usernameCheck.innerHTML = '';
                return;
            }

            usernameCheck.innerHTML = '<i class="fas fa-spinner fa-spin checking"></i>';

            usernameTimeout = setTimeout(() => {
                fetch(`/users/check-username?username=${encodeURIComponent(username)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            usernameCheck.innerHTML = '<i class="fas fa-times unavailable" title="Username unavailable"></i>';
                            usernameInput.classList.add('is-invalid');
                        } else {
                            usernameCheck.innerHTML = '<i class="fas fa-check available" title="Username available"></i>';
                            usernameInput.classList.remove('is-invalid');
                        }
                    })
                    .catch(() => {
                        usernameCheck.innerHTML = '';
                    });
            }, 500);
        });

        // Email availability check
        const emailInput = document.getElementById('email');
        const emailCheck = document.getElementById('emailCheck');
        let emailTimeout;

        emailInput.addEventListener('input', function() {
            clearTimeout(emailTimeout);
            const email = this.value.trim();

            if (!email || !email.includes('@')) {
                emailCheck.innerHTML = '';
                return;
            }

            emailCheck.innerHTML = '<i class="fas fa-spinner fa-spin checking"></i>';

            emailTimeout = setTimeout(() => {
                fetch(`/users/check-email?email=${encodeURIComponent(email)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            emailCheck.innerHTML = '<i class="fas fa-times unavailable" title="Email unavailable"></i>';
                            emailInput.classList.add('is-invalid');
                        } else {
                            emailCheck.innerHTML = '<i class="fas fa-check available" title="Email available"></i>';
                            emailInput.classList.remove('is-invalid');
                        }
                    })
                    .catch(() => {
                        emailCheck.innerHTML = '';
                    });
            }, 500);
        });

        // Password strength checker
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');

        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = [];

            if (password.length >= 8) strength += 1;
            else feedback.push('at least 8 characters');

            if (/[a-z]/.test(password)) strength += 1;
            else feedback.push('lowercase letters');

            if (/[A-Z]/.test(password)) strength += 1;
            else feedback.push('uppercase letters');

            if (/[0-9]/.test(password)) strength += 1;
            else feedback.push('numbers');

            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            else feedback.push('special characters');

            return { strength, feedback };
        }

        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const result = checkPasswordStrength(password);

            // Update strength bar
            strengthBar.className = 'password-strength-bar';
            if (result.strength >= 4) {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'Password strength: Strong';
            } else if (result.strength >= 3) {
                strengthBar.classList.add('strength-good');
                strengthText.textContent = 'Password strength: Good';
            } else if (result.strength >= 2) {
                strengthBar.classList.add('strength-fair');
                strengthText.textContent = 'Password strength: Fair';
            } else if (result.strength >= 1) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'Password strength: Weak';
            } else {
                strengthText.textContent = 'Password strength: None';
            }
        });

        // Password confirmation check
        function checkPasswordMatch() {
            if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.classList.add('is-invalid');
                return false;
            } else {
                confirmPasswordInput.classList.remove('is-invalid');
                return true;
            }
        }

        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
        passwordInput.addEventListener('input', checkPasswordMatch);

        // Form submission
        form.addEventListener('submit', function(e) {
            // Show loading state
            submitSpinner.classList.remove('d-none');
            submitIcon.classList.add('d-none');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
        });
    });
</script>
</body>
</html>